<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>KoreanLearnin</title>
    <script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "tt08azyz1t"); </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        /* --- Fix A: stop top-margin collapse on the very first child --- */
        html, body {
            margin: 0; 
            padding: 0;
            height: auto;
            min-height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        body {
          padding-top: 1px;
        }
        body > *:first-child,
        main > *:first-child,
        .container > *:first-child {
          margin-top: 0 !important;
        }

        /* --- Fix B: disable scroll-snap --- */
        html, body, main, .page, .container {
          scroll-snap-type: none !important;
        }

        /* --- Fix C: keep layout stable while images load --- */
        img { height: auto; max-width: 100%; }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
            margin: 0;
            padding: 0;
            color: white;
        }
        
        .container {
            position: relative;
            width: 100%;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: calc(2rem + env(safe-area-inset-top)) 2rem 2rem 2rem;
            background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;
            backdrop-filter: blur(10px);
            z-index: 1;
            animation: fadeInUp 0.8s ease-out;
            transition: padding 0.5s ease-out, opacity 0.5s ease-out, transform 0.5s ease-out;
            overflow: visible;
            -webkit-overflow-scrolling: touch;
        }
        
        .step {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .step.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .step.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1.5rem, 6vw, 3rem);
            margin-bottom: 2rem;
            color: white;
            text-shadow: -2px -2px 0 #31afed, 2px -2px 0 #31afed, -2px 2px 0 #31afed, 2px 2px 0 #31afed;
            line-height: 1.4;
        }
        
        .description {
            font-size: clamp(0.8rem, 3vw, 1.1rem);
            margin: 0 auto 2rem auto;
            opacity: 0.9;
            max-width: 700px;
            text-align: center;
            line-height: 1.6;
        }
        
        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        
        button {
            padding: clamp(12px, 3vw, 18px) clamp(24px, 5vw, 40px);
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 140px;
            margin: 0.5rem;
            font-family: 'Press Start 2P', cursive;
        }
        
        button.primary { 
            background: linear-gradient(45deg, #e74c3c, #c0392b); 
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); 
        }
        
        button.secondary { 
            background: linear-gradient(45deg, #9b59b6, #8e44ad); 
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); 
        }
        
        button.class-button { 
            background: linear-gradient(45deg, #3498db, #2980b9); 
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); 
        }
        
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); 
        }
        
        button:active { 
            transform: translateY(0); 
        }
        
        .hero-image {
            margin-top: 2rem;
            text-align: center;
            position: relative;
        }
        
        .hero-image img {
            max-width: 100%;
            height: auto;
            width: clamp(300px, 60vw, 550px);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(100vh);
            transition: transform 0.8s ease-out;
        }
        
        .hero-image.slide-up img {
            transform: translateY(0);
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .popup-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .popup-content {
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(231, 76, 60, 0.8);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
            padding: 0;
            min-width: unset;
            margin: 0;
        }
        
        .popup-close:hover {
            background: rgba(192, 57, 43, 1);
            transform: rotate(90deg);
        }
        
        .popup-content h2 {
            font-size: clamp(1rem, 3vw, 1.3rem);
            margin-bottom: 1.5rem;
            color: #FFD700;
            text-shadow: -2px -2px 0 #8B4513, 2px -2px 0 #8B4513, -2px 2px 0 #8B4513, 2px 2px 0 #8B4513;
        }
        
        .popup-content p {
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            line-height: 1.8;
            margin-bottom: 0.8rem;
            color: #FFFFFF;
        }
        
        .popup-content p strong {
            color: #90EE90;
            text-shadow: -1px -1px 0 #2F4F2F, 1px -1px 0 #2F4F2F, -1px 1px 0 #2F4F2F, 1px 1px 0 #2F4F2F;
        }
        
        .popup-time {
            color: #31afed;
            text-shadow: -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 1px 1px 0 #000000;
        }

        .class-container {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 800px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .price {
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            font-weight: bold;
            color: #FF1493;
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            border: none;
            text-shadow: -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000, 2px 2px 0 #000000;
            margin-top: auto;
        }

        .price-breakdown-link {
            font-size: clamp(0.6rem, 1.8vw, 0.75rem);
            color: #31afed;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 0.5rem;
            display: block;
        }

        .price-breakdown-link:hover {
            color: #5bc0de;
        }

        .pricing-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin: 2rem auto;
            max-width: 1400px;
            padding: 0 1rem;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .pricing-card h3 {
            font-size: clamp(0.9rem, 2.2vw, 1.15rem);
            color: #ffd700;
            margin-bottom: 1rem;
            text-align: center;
            text-shadow: -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000, 2px 2px 0 #000000;
        }
        
        .pricing-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 1.5rem 0;
            flex-grow: 1;
        }
        
        .pricing-card ul li {
            font-size: clamp(0.55rem, 1.5vw, 0.75rem);
            line-height: 1.6;
            margin-bottom: 0.8rem;
            padding-left: 1.2rem;
            position: relative;
            opacity: 0.9;
        }
        
        .pricing-card ul li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #31afed;
            font-weight: bold;
        }

        .pricing-card .price {
            line-height: 1.85;
        }

        /* Chat Interface Styles */
        .chat-container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .chat-message {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            animation: messageSlideIn 0.5s ease-out;
            line-height: 1.6;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.assistant {
            background: rgba(49, 175, 237, 0.2);
            border-left: 4px solid #31afed;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        .chat-message.user {
            background: rgba(155, 89, 182, 0.2);
            border-left: 4px solid #9b59b6;
            margin-left: 2rem;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        .chat-message.system {
            background: rgba(255, 215, 0, 0.2);
            border-left: 4px solid #ffd700;
            text-align: center;
            font-weight: bold;
            font-size: clamp(0.75rem, 2vw, 0.95rem);
        }

        .chat-message.error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        .chat-message.success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            font-size: clamp(0.8rem, 2vw, 1rem);
            font-family: 'Press Start 2P', cursive;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #31afed;
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-submit {
            padding: 1rem 2rem;
            min-width: 120px;
        }

        .timer-display {
            text-align: center;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            color: #ffd700;
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000;
            font-weight: bold;
            min-height: 2rem;
        }

        .timer-warning {
            color: #ff6b6b;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .chat-button {
            padding: 0.8rem 1.5rem;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            min-width: 100px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .chat-container {
                padding: 1rem;
            }

            .chat-messages {
                min-height: 300px;
                max-height: 400px;
            }

            .chat-message.user {
                margin-left: 1rem;
            }

            .chat-input-container {
                flex-direction: column;
            }

            .chat-submit {
                width: 100%;
            }

            .chat-button-group {
                margin-top: 0.5rem;
            }

            .chat-button {
                width: 100%;
            }
        }

        /* Blackboard Widget Styles */
        .blackboard-widget {
            max-width: 1035px;
            margin: 30px auto;
            padding: 20px 30px;
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border: 15px solid #8B4513;
            border-radius: 10px;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.8),
                0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Press Start 2P', cursive;
            min-height: 150px;
        }

        .bb-header {
            color: #fff;
            text-shadow: 1px 1px 3px rgba(255,255,255,0.3);
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .bb-underline {
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.6) 20%, 
                rgba(255,255,255,0.8) 50%, 
                rgba(255,255,255,0.6) 80%, 
                transparent 100%);
            margin: 10px auto 15px;
            width: 80%;
        }

        .class-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 15px;
        }

        .class-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            gap: 12px;
        }

        .class-name {
            color: #87CEEB;
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            text-shadow: 1px 1px 3px rgba(135,206,235,0.4);
            line-height: 1.3;
            flex-shrink: 0;
        }

        .seats-info {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .seats-count {
            font-size: clamp(1.2rem, 3vw, 1.6rem);
            font-weight: bold;
        }

        .seats-label {
            color: #ffd700;
            font-size: clamp(0.45rem, 1.2vw, 0.6rem);
            text-transform: uppercase;
        }

        /* Green for 4+ seats */
        .seats-high { 
            color: #00ff00;
            text-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        
        /* Yellow blinking for 2-3 seats */
        .seats-medium { 
            color: #ffff00;
            text-shadow: 0 0 20px rgba(255,255,0,0.5);
            animation: blink 1.2s ease-in-out infinite;
        }
        
        /* Red FAST blinking for 1 seat */
        .seats-urgent { 
            color: #ff4444;
            text-shadow: 0 0 30px rgba(255,68,68,0.8);
            animation: urgent-blink 0.5s ease-in-out infinite;
        }
        
        /* Solid red for sold out */
        .seats-out { 
            color: #ff4444;
            text-shadow: 0 0 30px rgba(255,68,68,0.8);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes urgent-blink {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1.1);
                text-shadow: 0 0 40px rgba(255,68,68,1);
            }
            50% { 
                opacity: 0.2;
                transform: scale(1);
                text-shadow: 0 0 20px rgba(255,68,68,0.5);
            }
        }

        .loading {
            color: #fff;
            text-align: center;
            padding: 30px;
            font-size: clamp(0.6rem, 1.8vw, 0.85rem);
        }

        .status-text {
            font-size: clamp(0.4rem, 1.1vw, 0.55rem);
            color: rgba(255,255,255,0.5);
            margin-left: 5px;
            font-style: normal;
        }

        /* Results Page Styles */
        .mistake-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ff6b6b;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .mistake-question {
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            color: #ffd700;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .mistake-answer {
            font-size: clamp(0.65rem, 1.8vw, 0.85rem);
            line-height: 1.8;
            margin: 0.5rem 0;
        }

        .mistake-your-answer {
            color: #ff6b6b;
        }

        .mistake-correct-answer {
            color: #90EE90;
        }

        /* Improvement Page Styles */
        .level-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 900px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .level-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .you-are-here {
            font-size: clamp(0.7rem, 2vw, 1rem);
            color: #ff4444;
            font-weight: bold;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            animation: pulse-glow 1.5s ease-in-out infinite;
            padding: 0.5rem 1rem;
            background: rgba(255, 68, 68, 0.2);
            border-radius: 20px;
        }

        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        .level-text {
            font-size: clamp(0.4rem, 1.2vw, 0.6rem);
            line-height: 2;
            color: white;
            text-align: left;
            opacity: 0.95;
            margin-bottom: 1rem;
        }

        #resultsTitle {
            font-size: clamp(1.3rem, 5vw, 2.5rem);
            text-align: center;
        }

        #resultLevel {
            color: #ffd700;
        }

        #levelDescription {
            white-space: pre-line;
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            line-height: 2;
        }

        .class-container h2 {
            text-align: center;
        }

        .level-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .level-header h2 {
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #31afed;
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000;
            margin: 0;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .hero-image img {
                width: clamp(320px, 95vw, 600px);
            }
            
            .popup-content {
                padding: 1.5rem;
            }

            .pricing-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 0.5rem;
            }
            
            .pricing-card {
                padding: 1.2rem;
            }
            
            .pricing-card ul li {
                font-size: 0.7rem;
            }
            
            #tutoringPricingPage .pricing-container {
                grid-template-columns: 1fr !important;
            }

            .blackboard-widget {
                max-width: 95%;
                padding: 15px 20px;
                margin: 20px auto;
                min-height: 120px;
            }

            .class-list {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .bb-header {
                font-size: clamp(0.7rem, 2vw, 0.9rem);
            }

            .class-name {
                font-size: clamp(0.45rem, 1.3vw, 0.6rem);
            }

            .seats-count {
                font-size: clamp(1rem, 3vw, 1.4rem);
            }

            .seats-label {
                font-size: clamp(0.4rem, 1vw, 0.5rem);
            }

            .status-text {
                font-size: clamp(0.4rem, 1vw, 0.5rem);
            }

            .level-section {
                padding: 1.5rem;
                margin: 1.5rem auto;
            }

            .level-header {
                flex-direction: column;
                align-items: center;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            .pricing-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .class-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media screen and (max-width: 435px) {
            button {
                transform: scale(0.9);
                transform-origin: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div id="welcomePage" class="step active">
            <h1>Welcome to the Level Tester!</h1>
            <p class="description">Want to know your level before you register for class? Let's get started!</p>
            
            <div class="hero-image" id="welcomeImage">
                <img src="https://cdn.shopify.com/s/files/1/0674/6747/7282/files/KOREANLEARNIN.png?v=1754436909" alt="Korean Learnin">
            </div>
            
            <div class="buttons">
                <button class="primary" onclick="showStep('disclaimerPage')">Start</button>
            </div>
        </div>

        <!-- Disclaimer Page -->
        <div id="disclaimerPage" class="step">
            <h1>‚ö†Ô∏è Warning!</h1>
            <div class="class-container">
                <p class="description">Welcome to the Level Test! You're allowed 2 incorrect answers before your level is scored. You have 25 seconds per question. Try your best and good luck!</p>
            </div>
            
            <div class="buttons">
                <button class="primary" onclick="startLevelTest()">I'm ready to take the test</button>
            </div>
        </div>

        <!-- Level Tester Page -->
        <div id="levelTesterPage" class="step">
            <h1>üéÆ Level Tester</h1>
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type your answer...">
                    <button onclick="submitAnswer()" id="sendButton" class="chat-submit">Send</button>
                </div>
                <div class="chat-button-group">
                    <button onclick="showResultsPage()" class="chat-button secondary">I'm done with the test</button>
                </div>
                <div id="timerDisplay" class="timer-display"></div>
            </div>
        </div>

        <!-- Completion Page -->
        <div id="completionPage" class="step">
            <h1>üéâ Test Complete!</h1>
            <div class="class-container">
                <p class="description">Thank you for taking the level test! Your results have been recorded.</p>
                <p class="description">We'll be in touch soon with next steps!</p>
            </div>
            
            <div class="buttons">
                <button class="primary" onclick="window.location.reload()">Take Another Test</button>
            </div>
        </div>

        <!-- Results Page - Shows level and mistakes -->
        <div id="resultsPage" class="step">
            <h1 id="resultsTitle">Your Level: <span id="resultLevel"></span></h1>
            
            <!-- Mistakes Review Section -->
            <div class="class-container" id="mistakesContainer" style="display: none;">
                <h2 style="color: #ff6b6b; text-align: center; font-size: clamp(1rem, 2.5vw, 1.3rem); margin-bottom: 1.5rem;">Review Your Answers</h2>
                <div id="mistakesList"></div>
            </div>
            
            <!-- Level Description -->
            <div class="class-container">
                <p class="description" id="levelDescription" style="text-align: left; line-height: 2;"></p>
            </div>
            
            <div class="buttons">
                <button class="primary" onclick="showStep('improvementPage')">How can I improve?</button>
            </div>
        </div>

        <!-- Improvement Roadmap Page - Shows all levels -->
        <div id="improvementPage" class="step">
            <h1>üìö Your Learning Path</h1>
            <p class="description">See where you are and where you're heading!</p>
            
            <!-- Absolute Beginner Section -->
            <div class="level-section" id="section-absolute-beginner">
                <div class="level-header">
                    <h2>ABSOLUTE BEGINNER</h2>
                    <span class="you-are-here" style="display: none;">YOU ARE HERE</span>
                </div>
                <p class="level-text">What you're doing RIGHT: You're already taking the first real step -- looking at Korean letters and trying to read them. Your brain is waking up to a new sound system, and you're brave enough to actually say Korean out loud, even if it feels awkward.</p>
                <p class="level-text">Your STRUGGLES: Right now, you're reading Korean with an "American mouth." Perhaps you can sound out words, but your lips, tongue, and rhythm are still English, so your Korean sounds foreign even when you're trying hard.</p>
                <p class="level-text">This doesn't mean you're "bad at Korean." It means no one has taught you how a Korean mouth moves. Most people don't even realize that matters! At this stage, you can't see WHAT you're struggling with without a visual or audio guide.</p>
                <p class="level-text">The SOLUTION: In our Tuesday Pronunciation Class at 8:00 PM EST, you'll get weekly customized evaluations, graphs to visualize your progress over time, and curated videos tailored to the exact pronunciation areas you score lowest in.</p>
            </div>
            
            <!-- Novice Section -->
            <div class="level-section" id="section-novice">
                <div class="level-header">
                    <h2>NOVICE</h2>
                    <span class="you-are-here" style="display: none;">YOU ARE HERE</span>
                </div>
                <p class="level-text">What you're doing RIGHT: You can't hold a full conversation yet, but you can catch bits and pieces. You can slowly read, write, and put together basic sentences. You've pushed past the total beginner fog, and Korean isn't a total mystery anymore. NOW you want to take your learning seriously. Your pronunciation is improving, you know some basic phrases, but you still rely on memorized lines and perhaps your vocabulary might feel weak.</p>
                <p class="level-text">Your STRUGGLES: Tiny but essential pieces (Ïù¥ÏóêÏöî/ÏòàÏöî, ÏûàÏñ¥Ïöî, Ïù¥ÏóàÏñ¥Ïöî/ÏòÄÏñ¥Ïöî, Ïóê/ÏóêÏÑú/ÏúºÎ°ú, ÏùÄ/Îäî vs. Ïù¥/Í∞Ä, ÏùÑ/Î•º) keep tripping you up. You can read the words, but choosing the right one and building your own sentences still feels confusing. You see these everywhere, but no one has ever explained them in a way that finally clicks, so you're stuck thinking, "I can read‚Ä¶ so why can't I actually say what I want?"</p>
                <p class="level-text">So what does this REALLY mean? It's not that you're not studying. You just haven't been taught these building blocks clearly. This is the level where we fix that!</p>
                <p class="level-text">The SOLUTION: For 6 weeks, join our Tuesday and Wednesday classes at 8 PM EST (Vocabulary + Pronunciation) with targeted particle and ending drills, so you can build your own short sentences with the right grammar -- without freezing or relying on memorized scripts. Get ready to speak on the fly!</p>
            </div>
            
            <!-- Beginner Section -->
            <div class="level-section" id="section-beginner">
                <div class="level-header">
                    <h2>BEGINNER</h2>
                    <span class="you-are-here" style="display: none;">YOU ARE HERE</span>
                </div>
                <p class="level-text">What you're doing RIGHT: You've got the basics down. Present tense feels comfortable, you know plenty of vocabulary, and you can introduce yourself, talk about hobbies, and make short, simple sentences.</p>
                <p class="level-text">Your STRUGGLES: Korean doesn't feel foreign anymore, but your sentences still come out short, choppy, and a little robotic. You rely on memorized simple sentences, and the moment you try to say anything more detailed, you get stuck.</p>
                <p class="level-text">What does this REALLY mean? You're not a complete beginner anymore. Your issue isn't "not enough vocab." It's that your sentences are flat and 1-dimensional. You know the pieces, but no one has shown you how to connect them into natural, flowing Korean. That painful gap is exactly what we fix.</p>
                <p class="level-text">The SOLUTION: At KoreanLearnin, we identify where your sentences break (connectors, structure, or length) and give you targeted drills and feedback to strengthen them. You'll start with up to 4 weekly classes at 8:00 PM EST, including Sentence Building and Listening classes on Mondays and Fridays, so your Korean becomes connected, natural, and genuinely what YOU want to say.</p>
            </div>
            
            <!-- Advanced Beginner Section -->
            <div class="level-section" id="section-advanced-beginner">
                <div class="level-header">
                    <h2>ADVANCED BEGINNER</h2>
                    <span class="you-are-here" style="display: none;">YOU ARE HERE</span>
                </div>
                <p class="level-text">What you're doing RIGHT: You know a lot of grammar, have strong vocabulary, and can write long, correct sentences when you have time.</p>
                <p class="level-text">Your STRUGGLES: But in real conversations, your brain works too hard. You build the sentence in English first, translate to Korean, feel the delay, and sometimes freeze. Your knowledge is stuck in the "thinking" stage instead of the "speaking" stage... and you're probably exhausted by vague advice like "just speak more."</p>
                <p class="level-text">What does this REALLY mean? You don't need more writing practice. You need to train your brain to speak FULLY on the fly! You should look at a prompt once, turn away from the screen, and say it in Korean from memory. This strengthens the basal ganglia (your "automatic speech" system), so Korean starts coming out naturally, not only when you can write it first.</p>
                <p class="level-text">The SOLUTION: Join our rigorous Thursday speaking classes at 8 PM EST. We'll train spontaneous conversation, use grammar software to target your weak spots, and teach you "Konglish bridge" techniques that stop you from translating in your head before speaking.</p>
            </div>
            
            <!-- Intermediate Section -->
            <div class="level-section" id="section-intermediate">
                <div class="level-header">
                    <h2>INTERMEDIATE</h2>
                    <span class="you-are-here" style="display: none;">YOU ARE HERE</span>
                </div>
                <p class="level-text">Placeholder for now</p>
            </div>
            
            <div class="buttons">
                <button class="primary" onclick="window.location.reload()">Take Another Test</button>
            </div>
        </div>
    </div>


    <script>
        // SERVER CONFIGURATION - Update this with your endpoint
        const SERVER_CONFIG = {
            endpoint: 'https://script.google.com/macros/s/AKfycbyGNLmW3ZgWJK7O9kNymdmCZzO87Mx5kGatxfcG-jTdbvsI9yUXEEyYol0agyYMw-PO6Q/exec',
            enabled: true
        };
        
        // Level Tester State
        let currentState = 'getName';
        let userName = '';
        let currentQuestionIndex = 0;
        let mistakeCount = 0;
        let timerInterval = null;
        let timeLeft = 25;
        let userLevel = '';
        let wrongAnswer = '';
        let contactInfo = {};
        let awaitingInput = false;
        
        /* 
        GRADING SYSTEM:
        
        Question Mapping:
        - Q1 (index 0): ABSOLUTE BEGINNER check
        - Q2-5 (indices 1-4): NOVICE (4 questions)
        - Q6-10 (indices 5-9): BEGINNER (5 questions, FIRST is index 5)
        - Q11-17 (indices 10-16): ADVANCED BEGINNER (7 questions, FIRST is index 10)
        - Q18-22 (indices 17-21): INTERMEDIATE (5 questions, FIRST is index 17)
        
        Rules:
        1. If Q1 wrong ‚Üí ABSOLUTE BEGINNER (always, but test continues)
        2. Test stops after 2 total mistakes
        3. Level is determined by WHERE the SECOND mistake occurred:
           - Exception: If second mistake is on the FIRST question of a new level (indices 5, 10, or 17),
             assign the PREVIOUS level instead
           - Otherwise: assign the level of the question where second mistake occurred
        
        Examples:
        - Wrong: Q2, Q5 ‚Üí Second mistake at Q5 (NOVICE) ‚Üí NOVICE
        - Wrong: Q2, Q6 ‚Üí Second mistake at Q6 (first BEGINNER) ‚Üí NOVICE (previous level)
        - Wrong: Q6, Q10 ‚Üí Second mistake at Q10 (BEGINNER) ‚Üí BEGINNER
        - Wrong: Q6, Q11 ‚Üí Second mistake at Q11 (first ADV BEGINNER) ‚Üí BEGINNER (previous level)
        */
        
        // Track mistakes by level for grading system
        let gotFirstQuestionWrong = false;
        let totalMistakes = 0;
        let mistakeQuestionIndices = []; // Track which question indices had mistakes
        let mistakesByLevel = {
            "NOVICE": 0,
            "BEGINNER": 0,
            "ADVANCED BEGINNER": 0,
            "INTERMEDIATE": 0
        };
        
        // Response tracking
        let testStartTime = null;
        let testEndTime = null;
        let responseSheet = {
            userName: '',
            level: '',
            testDate: new Date().toISOString(),
            responses: [],
            contactInfo: {},
            totalQuestions: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            timeouts: 0
        };

        // Questions with correct answers and level assignments
        const questions = [
            {
                question: "Can you read this?: Ï†ú Ïñ¥Î®∏ÎãàÎäî Í≥µÏõêÏóê Í∞îÏñ¥Ïöî (You do not need to know what it means)",
                type: "yesno",
                correctAnswer: "yes",
                failLevel: "ABSOLUTE BEGINNER"
            },
            {
                question: "What does this mean in English?\nÏò§Îäò Î≠ê ÌñàÏñ¥Ïöî?",
                type: "translation",
                correctAnswers: ["what did you do today", "what did you do today?", "what have you done today"],
                failLevel: "NOVICE"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏóÑÎßàÎäî ÏùòÏÇ¨ÏòÄÏñ¥Ïöî\"",
                type: "translation",
                correctAnswers: ["my mom was a doctor", "my mother was a doctor", "my mom was doctor", "my mother was doctor"],
                failLevel: "NOVICE"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏïÑÎ≤ÑÏßÄÎäî Ï£ºÏ∞®Ïû•Ïóê ÏûàÏñ¥Ïöî\"",
                type: "translation",
                correctAnswers: ["my father is at the parking lot", "my dad is at the parking lot", "my father is in the parking lot", "my dad is in the parking lot", "my father is at a parking lot", "my dad is at a parking lot"],
                failLevel: "NOVICE"
            },
            {
                question: "Provide the English Translation: Ï†ú ÎèôÏÉùÏùÄ ÏßëÏóê Í∞îÏñ¥Ïöî.",
                type: "translation",
                correctAnswers: [
                    "my younger sibling went home", 
                    "my sibling went home", 
                    "my younger brother went home", 
                    "my younger sister went home", 
                    "my brother went home", 
                    "my sister went home",
                    "my little brother went home",
                    "my little sister went home",
                    "my little sibling went home",
                    "my younger sibling went to home",
                    "my little sibling went to home"
                ],
                failLevel: "NOVICE"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏóÑÎßàÎäî ÏπúÍµ¨Îûë ÎßåÎÇòÍ≥† ÏïÑÎπ†Îäî ÏãùÎãπÏóê ÏûàÏñ¥Ïöî\"",
                type: "translation",
                correctAnswers: [
                    "my mom is meeting with a friend and my dad is at a restaurant", 
                    "my mother is meeting with a friend and my father is at a restaurant", 
                    "my mom meets with a friend and my dad is at a restaurant",
                    "my mom is meeting a friend and my dad is at a restaurant",
                    "my mother is meeting a friend and my father is at a restaurant"
                ],
                failLevel: "BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏóÑÎßàÌïòÍ≥† ÏßëÏóê Í∞îÏñ¥Ïöî\"",
                type: "translation",
                correctAnswers: ["i went home with my mom", "i went home with my mother"],
                failLevel: "BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏïÑÎπ†Îäî ÎÇöÏãúÌïòÎäî Í±∏ Ï¢ãÏïÑÌï¥Ïöî\"",
                type: "translation",
                correctAnswers: ["my dad likes fishing", "my father likes fishing", "my dad likes to fish", "my father likes to fish"],
                failLevel: "BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ú ÏóÑÎßàÎäî ÏßëÏóê Í∞ÄÎäî Í±∞ Í∞ôÏïÑÏöî\"",
                type: "translation",
                correctAnswers: [
                    "i think my mom is going home", 
                    "i think my mother is going home", 
                    "it seems like my mom is going home", 
                    "it seems like my mother is going home",
                    "it seems my mom is going home",
                    "it seems my mother is going home"
                ],
                failLevel: "BEGINNER"
            },
            {
                question: "Provide the English Translation: \"ÌïôÍµêÏóêÏÑú Î∞• Î®πÍ≥† ÏπúÍµ¨Îì§ÌïòÍ≥† ÏñòÍ∏∞ÌïòÎ†§Í≥† Ìï¥Ïöî\"",
                type: "translation",
                correctAnswers: [
                    "i'm going to eat at school and talk with friends", 
                    "i will eat at school and talk with friends", 
                    "i'm trying to eat at school and talk with friends",
                    "i'm going to eat at school and talk with my friends",
                    "i will eat at school and talk with my friends",
                    "i'm going to eat food at school and talk with friends"
                ],
                failLevel: "BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ÄÎäî ÎÇ¥Ïùº ÏòÅÌôîÎ•º Î≥º Í±∞ÏòàÏöî.\"",
                type: "translation",
                correctAnswers: ["i will watch a movie tomorrow", "i'm going to watch a movie tomorrow", "i will watch the movie tomorrow", "i'm going to watch the movie tomorrow", "i will watch movie tomorrow"],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ÄÎäî ÎÇòÏ§ëÏóê Í≥µÎ∂ÄÌï† Í±∞ÏòàÏöî.\"",
                type: "translation",
                correctAnswers: ["i will study later", "i'm going to study later", "i'll study later"],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†ÄÎäî Ïñ¥Ï†ú ÏπúÍµ¨Î•º ÎßåÎÇ¨Ïñ¥Ïöî.\"",
                type: "translation",
                correctAnswers: ["i met a friend yesterday", "i met my friend yesterday", "i met friend yesterday"],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Î®πÏùÑ Îç∞Í∞Ä ÏûàÎÇòÏöî?\"",
                type: "translation",
                correctAnswers: ["is there a place to eat", "is there somewhere to eat", "is there a place to eat at", "is there anywhere to eat"],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Î®πÏùÑÍ≤å ÎßéÏïÑÏöî\"",
                type: "translation",
                correctAnswers: ["there is a lot to eat", "there are many things to eat", "there is much to eat", "there's a lot to eat", "there are a lot of things to eat"],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "What does this mean in English: \"Ï†úÍ∞Ä ÏßëÏóê Í∞à Îïå, ÏπúÍµ¨Î•º ÎßåÎÇ¨Ïñ¥Ïöî.\"",
                type: "translation",
                correctAnswers: [
                    "when i was going home, i met a friend", 
                    "when i was going home i met a friend", 
                    "i met a friend when i was going home",
                    "when i was going home, i met my friend",
                    "when i was going home i met my friend",
                    "i met my friend when i was going home"
                ],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"ÎÇ¥Ïùº ÎπÑÍ∞Ä Ïò§Î©¥ ÏßëÏóê ÏûàÏùÑ Í±∞ÏòàÏöî.\"",
                type: "translation",
                correctAnswers: [
                    "if it rains tomorrow, i will stay home", 
                    "if it rains tomorrow i will stay home", 
                    "if it rains tomorrow, i will be at home",
                    "if it rains tomorrow i will be at home",
                    "if it rains tomorrow, i'll stay home",
                    "if it rains tomorrow i'll be at home"
                ],
                failLevel: "ADVANCED BEGINNER"
            },
            {
                question: "Provide the English Translation: \"Ï†úÍ∞Ä Ïò¨Ìï¥ ÏπúÍµ¨Îì§Ïù¥Îûë ÌïúÍµ≠Ïóê Í∞à Í±¥Îç∞, ÏãúÍ∞ÑÏù¥ ÏóÜÏñ¥ÏÑú Î™®Î•¥Í≤†Ïñ¥Ïöî.\"",
                type: "translation",
                correctAnswers: [
                    "i'm going to go to korea with friends this year, but i don't have time so i don't know", 
                    "i was going to go to korea with friends this year, but i don't have time so i'm not sure",
                    "i'm going to go to korea with my friends this year, but i don't have time so i don't know",
                    "i'm going to korea with friends this year, but i don't have time so i don't know",
                    "i'm going to go to korea with friends this year but i don't have time so i don't know"
                ],
                failLevel: "INTERMEDIATE"
            },
            {
                question: "What does this mean in English: \"Ìïú Îã¨ ÎèôÏïà ÌïúÍµ≠Ïóê ÏûàÏùÑ Í±∞ÏòàÏöî\"",
                type: "translation",
                correctAnswers: [
                    "i will be in korea for a month", 
                    "i will be in korea for one month",
                    "i'll be in korea for a month",
                    "i'll be in korea for one month"
                ],
                failLevel: "INTERMEDIATE"
            },
            {
                question: "Provide the English Translation: \"ÌïúÍµ≠Ïóê Í∞ÄÍ≥† Ïã∂ÏùÄÎç∞ ÏöîÏ¶òÏóê ÎÇ†Ïî®Í∞Ä ÎÑàÎ¨¥ Ï∂îÏõåÏÑú Î™ª Í∞àÍ±∞ Í∞ôÏïÑÏöî.\"",
                type: "translation",
                correctAnswers: [
                    "i want to go to korea but the weather is too cold these days so i don't think i can go", 
                    "i want to go to korea but these days the weather is too cold so i think i can't go",
                    "i want to go to korea but the weather is too cold lately so i don't think i can go",
                    "i want to go to korea but lately the weather is too cold so i don't think i can go"
                ],
                failLevel: "INTERMEDIATE"
            },
            {
                question: "Provide the English Translation: \"ÏàôÏ†úÎ•º Ìï¥Ïïº ÎèºÏÑú Ï†ÑÌôîÎ•º ÎÅäÏóàÏñ¥Ïöî\"",
                type: "translation",
                correctAnswers: [
                    "i hung up the phone because i had to do homework", 
                    "i hung up because i had to do homework",
                    "i hung up the phone because i had to do my homework",
                    "i hung up because i had to do my homework"
                ],
                failLevel: "INTERMEDIATE"
            },
            {
                question: "Provide the English Translation: \"ÏùòÏÇ¨ÌïúÌÖå Í≤ÄÏßÑÏùÑ Î∞õÏïÑÏïº ÎêòÎ©¥ Îπ®Î¶¨ Í∞ÄÏïº ÎèºÏöî\"",
                type: "translation",
                correctAnswers: [
                    "if you need to get a checkup from the doctor, you have to go quickly", 
                    "if you have to get a checkup from the doctor, you should go quickly",
                    "if you need to get a checkup from the doctor you have to go quickly",
                    "if you need to get a checkup from a doctor, you have to go quickly",
                    "if you have to get a checkup from a doctor, you should go quickly"
                ],
                failLevel: "INTERMEDIATE"
            }
        ];

        // Level descriptions
        const levelDescriptions = {
            "ABSOLUTE BEGINNER": "What you're doing RIGHT: You're already taking the first real step -- looking at Korean letters and trying to read them. Your brain is waking up to a new sound system, and you're brave enough to actually say Korean out loud, even if it feels awkward.\n\nYour STRUGGLES: Right now, you're reading Korean with an \"American mouth.\" Perhaps you can sound out words, but your lips, tongue, and rhythm are still English, so your Korean sounds foreign even when you're trying hard.\n\nThis doesn't mean you're \"bad at Korean.\" It means no one has taught you how a Korean mouth moves. Most people don't even realize that matters! At this stage, you can't see WHAT you're struggling with without a visual or audio guide.\n\nThe SOLUTION: In our Tuesday Pronunciation Class at 8:00 PM EST, you'll get weekly customized evaluations, graphs to visualize your progress over time, and curated videos tailored to the exact pronunciation areas you score lowest in.",
            
            "NOVICE": "What you're doing RIGHT: You can't hold a full conversation yet, but you can catch bits and pieces. You can slowly read, write, and put together basic sentences. You've pushed past the total beginner fog, and Korean isn't a total mystery anymore. NOW you want to take your learning seriously. Your pronunciation is improving, you know some basic phrases, but you still rely on memorized lines and perhaps your vocabulary might feel weak.\n\nYour STRUGGLES: Tiny but essential pieces (Ïù¥ÏóêÏöî/ÏòàÏöî, ÏûàÏñ¥Ïöî, Ïù¥ÏóàÏñ¥Ïöî/ÏòÄÏñ¥Ïöî, Ïóê/ÏóêÏÑú/ÏúºÎ°ú, ÏùÄ/Îäî vs. Ïù¥/Í∞Ä, ÏùÑ/Î•º) keep tripping you up. You can read the words, but choosing the right one and building your own sentences still feels confusing. You see these everywhere, but no one has ever explained them in a way that finally clicks, so you're stuck thinking, \"I can read‚Ä¶ so why can't I actually say what I want?\"\n\nSo what does this REALLY mean? It's not that you're not studying. You just haven't been taught these building blocks clearly. This is the level where we fix that!\n\nThe SOLUTION: For 6 weeks, join our Tuesday and Wednesday classes at 8 PM EST (Vocabulary + Pronunciation) with targeted particle and ending drills, so you can build your own short sentences with the right grammar -- without freezing or relying on memorized scripts. Get ready to speak on the fly!",
            
            "BEGINNER": "What you're doing RIGHT: You've got the basics down. Present tense feels comfortable, you know plenty of vocabulary, and you can introduce yourself, talk about hobbies, and make short, simple sentences.\n\nYour STRUGGLES: Korean doesn't feel foreign anymore, but your sentences still come out short, choppy, and a little robotic. You rely on memorized simple sentences, and the moment you try to say anything more detailed, you get stuck.\n\nWhat does this REALLY mean? You're not a complete beginner anymore. Your issue isn't \"not enough vocab.\" It's that your sentences are flat and 1-dimensional. You know the pieces, but no one has shown you how to connect them into natural, flowing Korean. That painful gap is exactly what we fix.\n\nThe SOLUTION: At KoreanLearnin, we identify where your sentences break (connectors, structure, or length) and give you targeted drills and feedback to strengthen them. You'll start with up to 4 weekly classes at 8:00 PM EST, including Sentence Building and Listening classes on Mondays and Fridays, so your Korean becomes connected, natural, and genuinely what YOU want to say.",
            
            "ADVANCED BEGINNER": "What you're doing RIGHT: You know a lot of grammar, have strong vocabulary, and can write long, correct sentences when you have time.\n\nYour STRUGGLES: But in real conversations, your brain works too hard. You build the sentence in English first, translate to Korean, feel the delay, and sometimes freeze. Your knowledge is stuck in the \"thinking\" stage instead of the \"speaking\" stage... and you're probably exhausted by vague advice like \"just speak more.\"\n\nWhat does this REALLY mean? You don't need more writing practice. You need to train your brain to speak FULLY on the fly! You should look at a prompt once, turn away from the screen, and say it in Korean from memory. This strengthens the basal ganglia (your \"automatic speech\" system), so Korean starts coming out naturally, not only when you can write it first.\n\nThe SOLUTION: Join our rigorous Thursday speaking classes at 8 PM EST. We'll train spontaneous conversation, use grammar software to target your weak spots, and teach you \"Konglish bridge\" techniques that stop you from translating in your head before speaking.",
            
            "INTERMEDIATE": "Placeholder for now"
        };

        // Show results page with mistakes and level description
        function showResultsPage() {
            // Check if level has been determined
            if (!userLevel) {
                addMessage("‚ö†Ô∏è Please complete the test first to see your results!", 'error');
                return;
            }
            
            // Populate level
            document.getElementById('resultLevel').textContent = userLevel;
            const description = levelDescriptions[userLevel] || "Congratulations on completing the test!";
            document.getElementById('levelDescription').innerHTML = description.replace(/\n\n/g, '<br><br>');
            
            // Get incorrect answers
            const incorrectAnswers = responseSheet.responses.filter(r => !r.isCorrect);
            
            if (incorrectAnswers.length > 0) {
                const mistakesContainer = document.getElementById('mistakesContainer');
                mistakesContainer.style.display = 'block';
                
                const mistakesList = document.getElementById('mistakesList');
                mistakesList.innerHTML = '';
                
                incorrectAnswers.forEach(mistake => {
                    const mistakeDiv = document.createElement('div');
                    mistakeDiv.className = 'mistake-item';
                    
                    mistakeDiv.innerHTML = `
                        <div class="mistake-question">Question ${mistake.questionNumber}: ${mistake.question}</div>
                        <div class="mistake-answer mistake-your-answer">Your answer: ${mistake.userAnswer}</div>
                        <div class="mistake-answer mistake-correct-answer">Correct answer: ${mistake.correctAnswer}</div>
                    `;
                    
                    mistakesList.appendChild(mistakeDiv);
                });
            } else {
                // No mistakes - hide the mistakes container
                document.getElementById('mistakesContainer').style.display = 'none';
            }
            
            // Show the results page
            showStep('resultsPage');
            
            // Mark the user's level on improvement page
            const levelMapping = {
                "ABSOLUTE BEGINNER": "absolute-beginner",
                "NOVICE": "novice",
                "BEGINNER": "beginner",
                "ADVANCED BEGINNER": "advanced-beginner",
                "INTERMEDIATE": "intermediate"
            };
            
            const sectionId = levelMapping[userLevel];
            if (sectionId) {
                // Hide all "YOU ARE HERE" markers first
                document.querySelectorAll('.you-are-here').forEach(marker => {
                    marker.style.display = 'none';
                });
                
                // Show the marker for user's level
                const userSection = document.querySelector(`#section-${sectionId} .you-are-here`);
                if (userSection) {
                    userSection.style.display = 'inline-block';
                }
            }
        }

        // Start level test from disclaimer
        function startLevelTest() {
            showStep('levelTesterPage');
            // Start the chat after a brief delay
            setTimeout(() => {
                initChat();
            }, 500);
        }

        // Initialize chat
        function initChat() {
            addMessage("Welcome my ÏπúÍµ¨! Let's determine your level!", 'assistant');
            setTimeout(() => {
                addMessage("First, what's your full name?", 'assistant');
                awaitingInput = true;
                focusInput();
            }, 1000);
        }

        // Add message to chat
        function addMessage(text, type = 'assistant') {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Focus on input
        function focusInput() {
            document.getElementById('chatInput').focus();
        }

        // Start timer
        function startTimer() {
            timeLeft = 25;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 5) {
                    document.getElementById('timerDisplay').classList.add('timer-warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            if (timeLeft > 0) {
                display.textContent = `‚è±Ô∏è Time left: ${timeLeft}s`;
            } else {
                display.textContent = '';
            }
        }

        // Clear timer
        function clearTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timerDisplay').textContent = '';
            document.getElementById('timerDisplay').classList.remove('timer-warning');
        }

        // Handle timeout
        function handleTimeout() {
            responseSheet.timeouts++;
            
            // Record the timeout response
            const question = questions[currentQuestionIndex];
            responseSheet.responses.push({
                questionNumber: currentQuestionIndex + 1,
                question: question.question,
                userAnswer: '[TIMEOUT]',
                correctAnswer: question.correctAnswers ? question.correctAnswers[0] : 'N/A',
                isCorrect: false,
                timeElapsed: 25,
                timestamp: new Date().toISOString()
            });
            
            addMessage("‚è∞ Time's up!", 'error');
            
            // Track if first question wrong
            if (currentQuestionIndex === 0) {
                gotFirstQuestionWrong = true;
            }
            
            // Increment total mistakes and record question index
            totalMistakes++;
            mistakeQuestionIndices.push(currentQuestionIndex);
            
            // Track mistake by level
            const level = question.failLevel;
            if (level !== "ABSOLUTE BEGINNER") {
                mistakesByLevel[level]++;
            }
            
            // Check if should stop test based on grading rules
            if (shouldStopTest()) {
                setTimeout(() => {
                    determineLevel();
                }, 1500);
            } else {
                // Continue to next question
                setTimeout(() => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        askNextQuestion();
                    } else {
                        completeTest();
                    }
                }, 1500);
            }
        }

        // Check if test should stop - stops after 2 mistakes total
        function shouldStopTest() {
            return totalMistakes >= 2;
        }

        // Normalize answer for comparison - lenient with typos
        function normalizeAnswer(answer) {
            let normalized = answer.toLowerCase()
                .replace(/[?.!,]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Handle common synonyms
            normalized = normalized
                .replace(/\bmom\b/g, 'mother')
                .replace(/\bmommy\b/g, 'mother')
                .replace(/\bmamma\b/g, 'mother')
                .replace(/\bmama\b/g, 'mother')
                .replace(/\bdad\b/g, 'father')
                .replace(/\bdaddy\b/g, 'father')
                .replace(/\bpapa\b/g, 'father')
                .replace(/\bsis\b/g, 'sister')
                .replace(/\bbro\b/g, 'brother');
            
            // Handle contractions
            normalized = normalized
                .replace(/\bim\b/g, 'i am')
                .replace(/\bi'm\b/g, 'i am')
                .replace(/\bim\b/g, 'i am')
                .replace(/\bill\b/g, 'i will')
                .replace(/\bi'll\b/g, 'i will')
                .replace(/\bdont\b/g, 'do not')
                .replace(/\bdon't\b/g, 'do not')
                .replace(/\bdidnt\b/g, 'did not')
                .replace(/\bdidn't\b/g, 'did not')
                .replace(/\bwont\b/g, 'will not')
                .replace(/\bwon't\b/g, 'will not')
                .replace(/\bcant\b/g, 'can not')
                .replace(/\bcan't\b/g, 'can not')
                .replace(/\bisnt\b/g, 'is not')
                .replace(/\bisn't\b/g, 'is not')
                .replace(/\bwasnt\b/g, 'was not')
                .replace(/\bwasn't\b/g, 'was not')
                .replace(/\barent\b/g, 'are not')
                .replace(/\baren't\b/g, 'are not')
                .replace(/\bwerent\b/g, 'were not')
                .replace(/\bweren't\b/g, 'were not')
                .replace(/\btheres\b/g, 'there is')
                .replace(/\bthere's\b/g, 'there is')
                .replace(/\btheyre\b/g, 'they are')
                .replace(/\bthey're\b/g, 'they are')
                .replace(/\bwere\b/g, 'we are')
                .replace(/\bwe're\b/g, 'we are')
                .replace(/\byoure\b/g, 'you are')
                .replace(/\byou're\b/g, 'you are');
            
            // Fix common typos
            normalized = normalized
                .replace(/\bteh\b/g, 'the')
                .replace(/\bwnet\b/g, 'went')
                .replace(/\bwnt\b/g, 'went')
                .replace(/\bgona\b/g, 'going to')
                .replace(/\bgonna\b/g, 'going to')
                .replace(/\bgunna\b/g, 'going to')
                .replace(/\bwanna\b/g, 'want to')
                .replace(/\btomorow\b/g, 'tomorrow')
                .replace(/\btommorow\b/g, 'tomorrow')
                .replace(/\btomorrow\b/g, 'tomorrow')
                .replace(/\byesterady\b/g, 'yesterday')
                .replace(/\byesturday\b/g, 'yesterday')
                .replace(/\bfreinds\b/g, 'friends')
                .replace(/\bfreind\b/g, 'friend')
                .replace(/\bwoudl\b/g, 'would')
                .replace(/\bcoudl\b/g, 'could')
                .replace(/\bshoudl\b/g, 'should')
                .replace(/\bwat\b/g, 'what')
                .replace(/\bwhta\b/g, 'what')
                .replace(/\bwitht\b/g, 'with')
                .replace(/\bwith\b/g, 'with')
                .replace(/\bresturant\b/g, 'restaurant')
                .replace(/\brestaraunt\b/g, 'restaurant')
                .replace(/\bresturaunt\b/g, 'restaurant')
                .replace(/\bparking lot\b/g, 'parking lot')
                .replace(/\bparkinglot\b/g, 'parking lot');
            
            return normalized;
        }

        // Check answer
        function checkAnswer(userAnswer) {
            const question = questions[currentQuestionIndex];
            const normalized = normalizeAnswer(userAnswer);
            
            if (question.type === 'yesno') {
                return normalized === 'yes' || normalized === 'y';
            } else {
                return question.correctAnswers.some(answer => 
                    normalizeAnswer(answer) === normalized
                );
            }
        }

        // Determine level based on where the second mistake occurred
        function determineLevel() {
            clearTimer();
            
            // Rule 1: If first question was wrong, always assign ABSOLUTE BEGINNER
            if (gotFirstQuestionWrong) {
                userLevel = "ABSOLUTE BEGINNER";
            } else {
                // Find the question index of the second mistake
                const secondMistakeIndex = mistakeQuestionIndices[1]; // 0-indexed array, so [1] is the second mistake
                
                // First question of each new level:
                // - BEGINNER starts at index 5 (Q6)
                // - ADVANCED BEGINNER starts at index 10 (Q11)
                // - INTERMEDIATE starts at index 17 (Q18)
                
                // If second mistake is on the first question of a new level, assign previous level
                if (secondMistakeIndex === 5) {
                    // First question of BEGINNER ‚Üí assign NOVICE
                    userLevel = "NOVICE";
                } else if (secondMistakeIndex === 10) {
                    // First question of ADVANCED BEGINNER ‚Üí assign BEGINNER
                    userLevel = "BEGINNER";
                } else if (secondMistakeIndex === 17) {
                    // First question of INTERMEDIATE ‚Üí assign ADVANCED BEGINNER
                    userLevel = "ADVANCED BEGINNER";
                } else {
                    // Otherwise, assign the level of the question where second mistake occurred
                    const question = questions[secondMistakeIndex];
                    userLevel = question.failLevel;
                }
            }
            
            testEndTime = new Date();
            responseSheet.level = userLevel;
            responseSheet.testDuration = Math.round((testEndTime - testStartTime) / 1000);
            
            addMessage(`üéØ YOU ARE A ${userLevel}`, 'system');
            setTimeout(() => {
                addMessage("Congrats!", 'success');
                setTimeout(() => {
                    explainMistake();
                    setTimeout(() => {
                        // Send to server
                        sendResponseToServer();
                        addMessage("Thank you for taking the test! Your results have been recorded. üéâ", 'success');
                        addMessage("Click 'I'm done with the test' to see your detailed results.", 'assistant');
                        awaitingInput = false;
                        document.getElementById('chatInput').disabled = true;
                        document.getElementById('sendButton').disabled = true;
                        document.getElementById('sendButton').style.opacity = '0.5';
                        document.getElementById('sendButton').style.cursor = 'not-allowed';
                    }, 2000);
                }, 1000);
            }, 1000);
        }

        // Explain mistake
        function explainMistake() {
            // Show the mistake that determined their level (the second mistake)
            const relevantMistakeIndex = mistakeQuestionIndices[1] !== undefined ? mistakeQuestionIndices[1] : currentQuestionIndex;
            const question = questions[relevantMistakeIndex];
            let explanation = '';
            
            if (question.type === 'yesno') {
                explanation = `The question "${question.question}" requires knowledge of Korean reading or comprehension at this level.`;
            } else {
                const userAnswer = responseSheet.responses.find(r => r.questionNumber === (relevantMistakeIndex + 1));
                const wrongAnswerText = userAnswer ? userAnswer.userAnswer : wrongAnswer;
                explanation = `The correct answer was: "${question.correctAnswers[0]}". You answered: "${wrongAnswerText}"`;
            }
            
            addMessage(explanation, 'assistant');
        }

        // Complete test (passed all questions) - ENSURES INTERMEDIATE LEVEL
        function completeTest() {
            clearTimer();
            userLevel = "INTERMEDIATE";
            testEndTime = new Date();
            responseSheet.level = userLevel;
            responseSheet.testDuration = Math.round((testEndTime - testStartTime) / 1000);
            
            addMessage(`üéØ YOU ARE INTERMEDIATE`, 'system');
            setTimeout(() => {
                addMessage("Congrats! You've passed all questions with flying colors!", 'success');
                setTimeout(() => {
                    // Send to server
                    sendResponseToServer();
                    addMessage("Thank you for taking the test! Your results have been recorded. üéâ", 'success');
                    addMessage("Click 'I'm done with the test' to see your detailed results.", 'assistant');
                    awaitingInput = false;
                    document.getElementById('chatInput').disabled = true;
                    document.getElementById('sendButton').disabled = true;
                    document.getElementById('sendButton').style.opacity = '0.5';
                    document.getElementById('sendButton').style.cursor = 'not-allowed';
                }, 1500);
            }, 1000);
        }

        // Test connection to Google Apps Script
        function testConnection() {
            console.log('üß™ Testing connection to Google Apps Script...');
            
            const testCallback = 'testCallback_' + Date.now();
            window[testCallback] = function(response) {
                console.log('‚úÖ CONNECTION TEST SUCCESSFUL!');
                console.log('Response:', response);
                delete window[testCallback];
                const script = document.querySelector(`script[data-testcallback="${testCallback}"]`);
                if (script && document.body.contains(script)) {
                    document.body.removeChild(script);
                }
            };
            
            const testData = {
                userName: 'Test User',
                level: 'TEST',
                totalQuestions: 1,
                correctAnswers: 1,
                incorrectAnswers: 0,
                responses: [{
                    questionNumber: 1,
                    question: 'Test',
                    userAnswer: 'Test',
                    correctAnswer: 'Test',
                    isCorrect: true
                }]
            };
            
            const script = document.createElement('script');
            script.setAttribute('data-testcallback', testCallback);
            const testUrl = `${SERVER_CONFIG.endpoint}?callback=${testCallback}&data=${encodeURIComponent(JSON.stringify(testData))}`;
            console.log('Test URL:', testUrl);
            script.src = testUrl;
            
            script.onerror = function(e) {
                console.error('‚ùå CONNECTION TEST FAILED');
                console.error('Error event:', e);
                console.error('Possible causes:');
                console.error('- Browser extension blocking the request');
                console.error('- Ad blocker interfering');
                console.error('- CSP (Content Security Policy) blocking');
                console.error('- Network issue');
                delete window[testCallback];
            };
            
            script.onload = function() {
                console.log('‚úÖ Script tag loaded');
            };
            
            document.body.appendChild(script);
        }

        // Send response sheet to server using JSONP to match Google Apps Script doGet
        function sendResponseToServer() {
            if (!SERVER_CONFIG.enabled) {
                console.log('Server submission disabled');
                return;
            }
            
            try {
                console.log('Sending response sheet to server...');
                console.log('Endpoint:', SERVER_CONFIG.endpoint);
                
                // Prepare response sheet data
                responseSheet.userName = userName;
                responseSheet.level = userLevel;
                responseSheet.totalQuestions = responseSheet.responses.length;
                responseSheet.correctAnswers = responseSheet.responses.filter(r => r.isCorrect).length;
                responseSheet.incorrectAnswers = responseSheet.totalQuestions - responseSheet.correctAnswers;
                
                console.log('Data to send:', responseSheet);
                
                // Create a unique callback name
                const callbackName = 'jsonpCallback_' + Date.now();
                
                // Create global callback function
                window[callbackName] = function(response) {
                    console.log('‚úÖ Response from server:', response);
                    if (response.success) {
                        console.log('‚úÖ Data successfully saved to Google Sheets');
                    } else {
                        console.error('‚ùå Server returned error:', response.error);
                    }
                    
                    // Cleanup
                    delete window[callbackName];
                    const script = document.querySelector(`script[data-callback="${callbackName}"]`);
                    if (script && document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                };
                
                // Build URL with parameters
                const dataString = JSON.stringify(responseSheet);
                const encodedData = encodeURIComponent(dataString);
                const fullUrl = `${SERVER_CONFIG.endpoint}?callback=${callbackName}&data=${encodedData}`;
                
                console.log('JSON data length:', dataString.length);
                console.log('URL length:', fullUrl.length);
                
                // Check URL length (Google has ~8KB limit for URLs)
                if (fullUrl.length > 8000) {
                    console.error('‚ùå URL too long:', fullUrl.length, 'characters');
                    console.log('Response sheet saved locally:', responseSheet);
                    return;
                }
                
                // Create script tag for JSONP
                const script = document.createElement('script');
                script.setAttribute('data-callback', callbackName);
                script.setAttribute('crossorigin', 'anonymous');
                script.src = fullUrl;
                
                script.onerror = function(error) {
                    console.error('‚ùå Script loading error:', error);
                    console.error('Script src:', script.src);
                    console.error('This usually means:');
                    console.error('1. Browser extension (ad blocker) is blocking the request');
                    console.error('2. The Google Apps Script is not responding');
                    console.error('3. Network/firewall issue');
                    console.log('');
                    console.log('üß™ Try running: testConnection()');
                    console.log('Response sheet saved locally:', responseSheet);
                    
                    // Cleanup
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                };
                
                script.onload = function() {
                    console.log('‚úÖ Script loaded successfully');
                };
                
                // Add timeout to detect issues
                const timeout = setTimeout(() => {
                    console.warn('‚ö†Ô∏è Request taking longer than 10 seconds...');
                    console.warn('The request may have failed silently');
                }, 10000);
                
                // Clear timeout when callback executes
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeout);
                    originalCallback(response);
                };
                
                document.body.appendChild(script);
                console.log('üì§ Request sent to Google Apps Script');
                
            } catch (error) {
                console.error('‚ùå Error sending response sheet to server:', error);
                console.log('Response sheet saved locally. Data:', responseSheet);
            }
        }

        // Ask if they want to continue

        // Ask next question
        function askNextQuestion() {
            const question = questions[currentQuestionIndex];
            addMessage(question.question, 'assistant');
            awaitingInput = true;
            startTimer();
            focusInput();
        }

        // Submit answer
        function submitAnswer() {
            if (!awaitingInput) return;
            
            const input = document.getElementById('chatInput');
            const answer = input.value.trim();
            
            if (!answer) return;
            
            addMessage(answer, 'user');
            input.value = '';
            awaitingInput = false;
            
            processAnswer(answer);
        }

        // Process answer based on current state
        function processAnswer(answer) {
            clearTimer();
            
            switch(currentState) {
                case 'getName':
                    userName = answer;
                    responseSheet.userName = userName;
                    testStartTime = new Date();
                    addMessage(`Nice to meet you, ${userName}! Let's begin the test.`, 'assistant');
                    setTimeout(() => {
                        currentState = 'testing';
                        askNextQuestion();
                    }, 1500);
                    break;
                    
                case 'testing':
                    wrongAnswer = answer;
                    const isCorrect = checkAnswer(answer);
                    const question = questions[currentQuestionIndex];
                    
                    // Record the response
                    const responseTime = 25 - timeLeft;
                    responseSheet.responses.push({
                        questionNumber: currentQuestionIndex + 1,
                        question: question.question,
                        userAnswer: answer,
                        correctAnswer: question.correctAnswers ? question.correctAnswers[0] : (question.correctAnswer === 'yes' ? 'Yes' : 'No'),
                        isCorrect: isCorrect,
                        timeElapsed: responseTime,
                        timestamp: new Date().toISOString()
                    });
                    
                    if (isCorrect) {
                        addMessage("‚úÖ Correct!", 'success');
                        setTimeout(() => {
                            currentQuestionIndex++;
                            if (currentQuestionIndex < questions.length) {
                                askNextQuestion();
                            } else {
                                // All questions answered correctly - INTERMEDIATE level
                                completeTest();
                            }
                        }, 1000);
                    } else {
                        addMessage("‚ùå Incorrect.", 'error');
                        
                        // Track if first question wrong
                        if (currentQuestionIndex === 0) {
                            gotFirstQuestionWrong = true;
                        }
                        
                        // Increment total mistakes and record question index
                        totalMistakes++;
                        mistakeQuestionIndices.push(currentQuestionIndex);
                        
                        // Track mistake by level
                        const level = question.failLevel;
                        if (level !== "ABSOLUTE BEGINNER") {
                            mistakesByLevel[level]++;
                        }
                        
                        // Check if should stop test based on grading rules
                        if (shouldStopTest()) {
                            setTimeout(() => {
                                determineLevel();
                            }, 1500);
                        } else {
                            // Continue to next question
                            setTimeout(() => {
                                currentQuestionIndex++;
                                if (currentQuestionIndex < questions.length) {
                                    askNextQuestion();
                                } else {
                                    completeTest();
                                }
                            }, 1500);
                        }
                    }
                    break;
                    
                case 'end':
                    addMessage("Thank you! Feel free to explore our other resources.", 'success');
                    awaitingInput = false;
                    break;
            }
        }

        // Handle Enter key
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('chatInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
            
            // Trigger welcome image slide-up animation
            setTimeout(() => {
                const welcomeImage = document.getElementById('welcomeImage');
                if (welcomeImage) {
                    welcomeImage.classList.add('slide-up');
                }
            }, 300);
        });

        // Page Navigation (keep existing function)
        function showStep(stepId) {
            const allSteps = document.querySelectorAll('.step');
            const currentActive = document.querySelector('.step.active');
            
            if (currentActive) {
                currentActive.classList.add('fade-out');
            }
            
            setTimeout(() => {
                allSteps.forEach(step => {
                    step.classList.remove('active', 'fade-out');
                });
                const targetStep = document.getElementById(stepId);
                if (targetStep) {
                    targetStep.classList.add('active');
                    
                    // Trigger image slide if returning to welcome page
                    if (stepId === 'welcomePage') {
                        setTimeout(() => {
                            const welcomeImage = document.getElementById('welcomeImage');
                            if (welcomeImage) {
                                welcomeImage.classList.add('slide-up');
                            }
                        }, 300);
                    }
                    
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        document.documentElement.scrollTop = 0;
                        document.body.scrollTop = 0;
                    }, 0);
                }
            }, currentActive ? 300 : 0);
        }
        
        // Scroll management
        (function () {
            try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch(e){}

            document.addEventListener('DOMContentLoaded', function () {
                if (!document.getElementById('top-sentinel')) {
                    var s = document.createElement('div');
                    s.id = 'top-sentinel';
                    s.style.cssText = 'height:1px;margin:0;padding:0;';
                    document.body.insertBefore(s, document.body.firstChild);
                }
            });

            function toTop() {
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            }

            document.addEventListener('DOMContentLoaded', function () {
                requestAnimationFrame(toTop);
                setTimeout(toTop, 200);
            });
            window.addEventListener('load', function () { setTimeout(toTop, 0); }, { once: true });
            window.addEventListener('pageshow', function (e) { if (e.persisted) toTop(); });
        })();
    </script>
</body>
</html>
